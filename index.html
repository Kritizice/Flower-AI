<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>AI Bouquet Designer</title>
  <style>
    body{font-family:Arial;background:#fdf2f2;margin:2rem}
    textarea{width:100%;height:80px}
    img{max-width:300px}
    button{padding:.6rem 1.2rem;background:#e91e63;color:#fff;border:none;cursor:pointer}
  </style>
</head>
<body>

<h2>Describe your dream bouquet</h2>
<textarea id="prompt" placeholder="e.g. romantic red and white with strawberries"></textarea><br>
<button onclick="go()">Generate</button>
<div id="out"></div>

<script type="module">
import CryptoJS from 'https://cdn.skypack.dev/crypto-js';

const OR_KEY        = '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'; // your permanent OR key
const STAFF_PASSWORD = 'myFlorist123';

window.go = async () => {
  const prompt = document.getElementById('prompt').value;
  document.getElementById('out').innerText = 'Working…';

  // 1. load shop rules
  const rules = await (await fetch('rules.json')).json();

  // 2. ask OpenRouter (DeepSeek-free tier today)
  const reply = await fetch('https://openrouter.ai/api/v1/chat/completions',{
    method : 'POST',
    headers: {
      'Content-Type'  : 'application/json',
      'Authorization' : `Bearer ${OR_KEY}`,
      'HTTP-Referer'  : 'https://kritizice.github.io',
      'X-Title'       : 'Flower-AI'
    },
    body: JSON.stringify({
      model: 'deepseek/deepseek-r1-distill-llama-70b:free',   // free today
      messages:[
        {role:'system', content:`You are a florist AI. Obey these rules:\n${JSON.stringify(rules,null,2)}\nReturn ONLY this JSON shape:\n{"flowers":[{"type":"","color":"","qty":}],"fruits":[{}],"style":""}`},
        {role:'user',   content: prompt}
      ]
    })
  });
  const recipe = JSON.parse((await reply.json()).choices[0].message.content);

  // 3. price
  let cost = 0;
  recipe.flowers.forEach(f => cost += f.qty * rules.priceStem[f.type]);
  recipe.fruits.forEach(fr => cost += fr.qty * rules.priceFruit[fr.type]);
  cost = Math.round(cost * rules.profit * 100) / 100;

  // 4. image (Pollinations, no key)
  const imgPrompt = `bouquet, ${recipe.flowers.length} flowers, ${recipe.fruits.length} fruits, ${recipe.style}, pastel background, 4k`;
  const imgUrl    = `https://image.pollinations.ai/prompt/${encodeURIComponent(imgPrompt)}?width=1024&height=1024&nologo=1`;

  // 5. encrypt & save
  const cipher = CryptoJS.AES.encrypt(JSON.stringify({recipe,cost,imgPrompt}), STAFF_PASSWORD).toString();
  const code   = CryptoJS.lib.WordArray.random(4).toString();
  const gistPayload = {description:'new order',public:true,files:{[`${code}.txt`]:{content:cipher}}};
  await fetch('https://api.github.com/gists',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(gistPayload)});

  // 6. display
  document.getElementById('out').innerHTML = `
    <img src="${imgUrl}" width="300"><br>
    <b>€${cost}</b><br>
    Flowers: ${recipe.flowers.map(f=>`${f.qty} ${f.color} ${f.type}`).join(', ')}<br>
    Fruits: ${recipe.fruits.map(fr=>`${fr.qty} ${fr.type}`).join(', ')}<br>
    Your secret code: <code>${cipher.slice(0,8)}…</code>`;
};
</script>
</body>
</html>
